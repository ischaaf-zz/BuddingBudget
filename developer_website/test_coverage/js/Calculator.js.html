<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for js/Calculator.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">js/</a> Calculator.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.71% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>89/96</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>21/28</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.71% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>89/96</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">49×</span>
<span class="cline-any cline-yes">49×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">49×</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-yes">106×</span>
<span class="cline-any cline-yes">52×</span>
<span class="cline-any cline-yes">52×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-yes">54×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">88×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">68×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">88×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">88×</span>
<span class="cline-any cline-yes">88×</span>
<span class="cline-any cline-yes">88×</span>
<span class="cline-any cline-yes">88×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">71×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// At some point, we could make this just a function within
// DataManager, but I wanted to keep it separate for now
// so we definitely wouldn't have any merge conflicts if
// both get changed.
var Calculator = function() {
&nbsp;
	var self = this;
&nbsp;
	// Calculates and returns the budget for today based upon the
	// passed in data.
	this.calculateBudget = function(data) {
		var entry = data.trackedEntry;
		var assetAdjust = -data.rollover;
		<span class="missing-if-branch" title="if path not taken" >I</span>if(entry &amp;&amp; !$.isEmptyObject(entry)) {
<span class="cstat-no" title="statement not covered" >			assetAdjust += entry.amount;</span>
		}
		return calculate(data, new Date(), assetAdjust, data.rollover, false);
	};
&nbsp;
	// Calculates and returns the budget for tomorrow based upon
	// the passed in data
	this.calculateTomorrowBudget = function(data) {
		var entry = data.trackedEntry;
		var assetAdjust = -data.tomorrowRollover;
		<span class="missing-if-branch" title="else path not taken" >E</span>if(!entry || $.isEmptyObject(entry)) {
			assetAdjust -= data.budget;
		}
		var tomorrow = new Date();
		tomorrow.setDate(tomorrow.getDate() + 1);
		return calculate(data, tomorrow, assetAdjust, data.tomorrowRollover, true);
	};
&nbsp;
	// Calculates a budget based upon the passed in data
	// Assumes that the current day is whatever is contained in "now"
	// Adjusts the assets by assetAdjust before calculating, and the calculated
	// budget by budgetAdjust after the calculation.
	// If considerTodayRecurring is true, considers recurring charges that go through today.
	// This must be false if we're calculating today's budget, since assets will already be modified with the
	// charges / income, and must be true otherwise.
	function calculate(data, now, assetAdjust, budgetAdjust, considerTodayRecurring) {
		// calculate budget by basically dividing the assets by the amount of days left and return that value.
		// Because of possible interleving incomes and charges, the algorithm has to be more sophisticated.
&nbsp;
		// make sure dates are have no information about the hour, minute, seconds and milliseconds 
		// var now = new Date();
		var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
		var endDate = new Date(data.endDate);
		endDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
		<span class="missing-if-branch" title="if path not taken" >I</span>if(!isTodayOrLater(endDate)) {
<span class="cstat-no" title="statement not covered" >			return 0;</span>
		}
&nbsp;
		// calculate the available assets
		var sumOfSavings = 0;
		for(var i = 0; i &lt; data.savings.length; i++) {
			sumOfSavings += data.savings[i].amount;
		}
		var availableAssets = data.assets - sumOfSavings + assetAdjust;
&nbsp;
		// calculate all changes that occur due to income and charges and save them in "changes" with the date as the key.
		var changes = {};
		var nextTime;
		var currentDay = new Date(today);
		changes[currentDay.getTime()] = availableAssets;
		for(i = 0; i &lt; data.income.length; i++) {
			currentDay = new Date(today);
			<span class="missing-if-branch" title="if path not taken" >I</span>if(considerTodayRecurring) {
<span class="cstat-no" title="statement not covered" >				currentDay.setDate(currentDay.getDate() - 1);</span>
			}
			while(findNextTime(data.income[i], currentDay) &lt;= endDate.getTime()) {
				nextTime = findNextTime(data.income[i], currentDay);
				var amountUsable = data.income[i].amount - data.income[i].holdout;
				<span class="missing-if-branch" title="if path not taken" >I</span>if(changes[nextTime]) {
<span class="cstat-no" title="statement not covered" >					changes[nextTime] += amountUsable;</span>
				} else {
					changes[nextTime] = amountUsable;
				}
				currentDay = new Date(nextTime);
			}
		}
		for(i = 0; i &lt; data.charges.length; i++) {
			currentDay = new Date(today);
			<span class="missing-if-branch" title="if path not taken" >I</span>if(considerTodayRecurring) {
<span class="cstat-no" title="statement not covered" >				currentDay.setDate(currentDay.getDate() - 1);</span>
			}
			while(findNextTime(data.charges[i], currentDay) &lt;= endDate.getTime()) {
				nextTime = findNextTime(data.charges[i], currentDay);
				if(changes[nextTime]) {
					changes[nextTime] -= data.charges[i].amount;
				} else {
					changes[nextTime] = -data.charges[i].amount;
				}
				currentDay = new Date(nextTime);
			}
		}
		// sort date keys in changes - decreasing
		var dates = [];
		for(var date in changes) {
			dates.push(date);
		}
		dates.sort().reverse();
&nbsp;
		// compensate negative income days with earlier positive income to get rid of them
		var compensationAmount = 0;
		for(i = 0; i &lt; dates.length; i++) {
			changes[dates[i]] += compensationAmount;
			compensationAmount = 0;
			if(changes[dates[i]] &lt;= 0) {
				compensationAmount += changes[dates[i]];
				delete changes[dates[i]];
			}
		}
		// TODO: error if negative at end
&nbsp;
		// sort date keys in changes again after deleting entries, this time increasing
		dates = [];
		for(var dateKey in changes) {
			dates.push(dateKey);
		}
		dates.sort();
&nbsp;
		return maxAmountToSpend(changes, endDate) + budgetAdjust;
&nbsp;
		// calculates the maximum amount one can spend on the first day to still be able
		// to get to endDate optimally
		function maxAmountToSpend(changes, endDate) {
			// We assume we would have all the income on our begin date and sum up all the incomes.
			var amountAvailable = 0;
			for(var i = 0; i &lt; dates.length; i++) {
				if(dates[i] &gt; endDate.getTime()) {
					break;
				}
				amountAvailable += changes[dates[i]];
			}
&nbsp;
			// Check how long one can use the daily amount until one runs out of money. If that is the end date
			// output the daily amount. Else try again with not all the incomes available, but only the ones 
			// until the point we previously had no more money left.
			var differenceMilliseconds = endDate - today;
			var differenceDays = Math.round(differenceMilliseconds / MILLISECONDS_PER_DAY) + 1;
			var dailyAmount = amountAvailable / differenceDays;
			var lastDatePossible = getLastDayPossible(dailyAmount);
			<span class="missing-if-branch" title="if path not taken" >I</span>if(isNaN(lastDatePossible.getTime())) {
<span class="cstat-no" title="statement not covered" >				console.log("ERROR");</span>
<span class="cstat-no" title="statement not covered" >				return 0;</span>
			}
			if(lastDatePossible &gt;= endDate) {
				return Math.floor(dailyAmount);
			} else {
				return maxAmountToSpend(changes, lastDatePossible);
			}
&nbsp;
			// simulate how long the dailyAmount will last with the assets as well as all the incomes.
			function getLastDayPossible(dailyAmount) {
				var amountAvailable = 0;
				var lastDate = today;
				for(var i = 0; i &lt; dates.length; i++) {
					var differenceMilliseconds = dates[i] - lastDate.getTime();
					// TODO: check if +1 needed for inclusive end date
					var differenceDays = Math.round(differenceMilliseconds / MILLISECONDS_PER_DAY);
					lastDate = new Date(Number(dates[i]));
					amountAvailable -= dailyAmount * differenceDays;
					if(amountAvailable &lt; 0) {
						lastDate.setDate(lastDate.getDate() - 1);
						return lastDate;
					}
					amountAvailable += changes[dates[i]];
				}
				return endDate;
			}
		}
	}
&nbsp;
};</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Feb 26 2016 02:26:27 GMT-0800 (PST)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
